<html>

<head>
  <!-- TODO: Pretty up with Bootstrap, move scripts and styles to external files, deploy to Heroku static page -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.16/p5.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <style>
    body {
      background-color: ivory;
      font-family: Helvetica;
    }
    #about{
      width: 50%;
    }
    #instructions{
      width: 50%;
    }
    #about, #instructions, #upcoming{
      padding: 1%;
    }
    #about{
      float: right;
    }
    h1, copyright{
      float: left;
      padding-right: 2%;
    }
    copyright{
      margin-left: 40%;
      float: left;
    }
  #container{
    /* border: 2px solid red; */
    max-height: 325px;
    max-width: 925px;
    width: 100%;
    height: 100%;
   margin: auto;
   padding: 1%;
   overflow-x: auto;
   overflow-y: visible;
  }
  #addModule, #myCanvas{
    margin-right: 3%;
    float: left;
  }
  #addModule{
    border: 2px solid black;
    width: 550px;
    height: 300px;
  }
  #myCanvas{
    border: 2px solid black;
  }
  #module{
    margin: 1%;
  }

  </style>
</head>

<body>
  <header>
  <h1>PitchCanvas</h1> <copyright><small>Â©2017 Nathan Bloomfield All Rights Reserved</small></copyright>
</header>
  <br>
  <div id='container'>
  <canvas id='myCanvas' width='300' height='300'></canvas>
  <div id='addModule'><div id='module'>
    <h4>Summary: </h4>
    A pitch circle represents the chromatic scale, ascending in clockwise direction. One circle represents all transpositions.
    For more information, check out Miles Okazaki's <a href='http://www.milesokazaki.com/wp-content/uploads/2016/02/visual-reference-smaller.pdf#page=5' target='_blank'><em>Visual Reference for Musicians (p5)</em></a>.
    <br>
    <br>
    Additional modules will appear here when created. See About, Instructions, and Upcoming Features below.
    <br>
    <br>
  Questions or comments? I'd love to hear from you!<br><br> Drop me a line at: bloom510@protonmail.com
  </div>
</div>
</div>
  <br>
  <div id='about'>
    <h4>About</h4>
    This module provides an environment for visualization of harmonic structures on a 2-dimensional plane using HTML5 Canvas and JavaScript. It is intended for use as an educational tool for the demonstration of musical concepts in future applications
    as well as a being a vehicle for harmonic exploration.
  </div>
  <div id='instructions'>
    <h4>Instructions</h4>
    <ul>
      <li>Click any dot to initialize the line tool from that point.</li>
      <br>
      <li>Click on any other dot to draw a line from your last selection to the current one.</li>
      <br>
      <li>Shortcuts: Press the 'L' key to lift the brush, and press the 'X' key to erase your work.</li>
    </ul>
  </div>
  <div id='upcoming'>
    <h4>Upcoming features:</h4>
    <ul>
      <li>Extended Drawing UI (color coding, object oriented, rotation, etc)</li>
      <li>Map note names to each pitch coordinate and use WebAudio API for MIDI playback</li>
      <li>Visualize whole and half-steps with arrows for pedagogical purposes</li>
      <li>Integrate VexFlow for staff notation for multiple perspectives</li>
    </ul>
  </div>
  <script>
    let canvas = document.querySelector("#myCanvas");
    let context = canvas.getContext("2d");
    let circles = [];

    //TODO: 1. Create line Object and push to an array similarly to circles.
    //      2. Allow color coding of lines as well as grouping into objects

    //create singular circle object for dots in pitch circle
    let circle = {
      radius: 100,
      xPos: canvas.width / 2,
      yPos: canvas.height / 2,
      color: "black",
      coords: '',

      setColor: function(newColor) {
        this.color = newColor;
      },

      draw: function(x, y) {
        context.beginPath();
        context.arc(x, y, 2, 0, Math.PI * 2);
        context.fillStyle = this.color;
        context.fill();

      }
    };

    //Draw pitch circle
    function PitchCircle() {
      for (let i = 0; i < 12; i++) {
        //Circle divided by number of dots
        let interval = (Math.PI * 2) / 12;
        //spacial distribution of each dot
        let radianAngle = interval * (i + 9);
        let x = Math.round(circle.xPos + circle.radius * Math.cos(radianAngle));
        let y = Math.round(circle.yPos + circle.radius * Math.sin(radianAngle));
        let newCircle = Object.create(circle);
        newCircle.x = x;
        newCircle.y = y;
        newCircle.draw(x, y);
        circles.push(newCircle);
      }
    }

    PitchCircle();


    //HOW TO ACCESS AND CHANGE PROPERTIES OF INDIVIDUAL POINTS.
    // let firstCircle = circles[0];
    // firstCircle.setColor("rgba(255, 204, 0, 1)");
    // firstCircle.draw(firstCircle.x, firstCircle.y);

    //BEGIN EVENT HANDLERS

    //Detect dot clicks
    let lineInit = false;
    canvas.onmousedown = function(e) {
      let mousePos = getMousePos(canvas, e);
      let drawFromX = 0;
      let drawFromY = 0;

      for (i = 0; i < circles.length; i++) {
        y = mousePos.y - circles[i].y;
        x = mousePos.x - circles[i].x;
        let dist = Math.sqrt(y * y + x * x);
        if (dist < 5) {
          if (lineInit === true) {
            console.log('drawing line');
            context.lineTo(circles[i].x, circles[i].y);
            context.stroke();
            // lineInit = false;
          } else {
            console.log('dot clicked');
            context.moveTo(circles[i].x, circles[i].y);
            lineInit = true;
            // circles[i].setColor("rgba(255, 204, 0, 1)");
            // circles[i].draw(circles[i].x,  circles[i].y);
          }
        }
      }
    }



    //Get mouse position
    function getMousePos(canvas, e) {
      let rect = canvas.getBoundingClientRect();
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }

    //Begin keypress shortcuts
    document.onkeypress = function(e) {
      let x = e.which || e.keyCode;
      if (x === 108) {
        alert("Brush lifted");
        lineInit = false;
      } else if (x === 120) {
        context.clearRect(0, 0, canvas.width, canvas.height);
        PitchCircle();
        lineInit = false;
      } else {
        alert(e.keyCode);
      }
    }
  </script>
</body>

</html>
